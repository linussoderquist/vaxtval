<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hitta lämpliga inhemska växtarter (SOS Export)</title>
  <link rel="icon" href="icon.png" type="image/png" sizes="32x32">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b0f14;--text:#ecf1f6;--muted:#a5b6c9;--hl:#77aaff}
    html,body{
      margin:0;background:var(--bg);color:var(--text);
      font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",Arial,sans-serif
    }
    header{padding:12px 16px;border-bottom:1px solid #1a2533;background:#0d1420}
    h1{margin:0 0 6px;font-size:26px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input[type="number"],input[type="text"]{
      background:#0a1320;border:1px solid #263447;color:var(--text);border-radius:8px;padding:8px 10px}
    input[type="number"]{width:120px}
    button{background:#0f2134;border:1px solid #2b4460;border-radius:12px;color:#eaf2fa;padding:9px 14px;cursor:pointer}
    button:hover{filter:brightness(1.06)}
    #statusMsg{color:var(--muted);font-size:13px;margin-left:6px}
    label.chk{display:inline-flex;align-items:center;gap:6px}
    #map{height:54vh}
    table{width:100%;border-collapse:separate;border-spacing:0 6px;margin:12px 0}
    thead th{font-size:13px;color:var(--muted);text-align:left;cursor:pointer;padding:6px 8px;background:#0e1724}
    tbody tr{background:#0f1723;border:1px solid #1e2b3b}
    tbody td{padding:8px 10px}
    tr:hover{outline:1px solid #27405f}
    tr.selected{outline:2px solid gold;background-color:#3b2b00}
    .tag{font-size:11px;border:1px solid #2a4462;border-radius:999px;padding:2px 6px;color:#cfe1ff;background:#0e1b2f}
    .hint{font-size:13px;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
  <header>
    <h1>Hitta lämpliga inhemska växtarter</h1>
    <div class="controls">
      <label id="csvPicker">vaxtdata.csv
        <input type="file" id="csvInput" accept=".csv">
      </label>
      Radie (m): <input type="number" id="radiusInput" value="500" min="10" step="10">
      <label class="chk"><input type="checkbox" id="ignoreCsv"> Ignorera CSV (visa alla)</label>
      <button id="analyzeBtn">Analysera</button>
      <span id="statusMsg">1) CSV laddas…  2) Klicka i kartan  3) Analysera</span>
    </div>
    <div class="hint">För GitHub Pages: lägg <code>index.html</code>, <code>vaxtdata.csv</code> och <code>icon.png</code> i samma mapp.</div>
  </header>

  <!-- Donut-progress -->
  <div id="progressContainer" style="display:none;position:fixed;z-index:9999;right:16px;bottom:16px;
    width:120px;height:120px;padding:6px;border-radius:14px;background:rgba(13,20,32,.85);box-shadow:0 8px 24px rgba(0,0,0,.35);">
    <canvas id="progressDonut" width="120" height="120"></canvas>
    <img src="icon.png" alt="ikon" style="position:absolute;top:50%;left:50%;width:48px;height:48px;transform:translate(-50%,-50%);pointer-events:none;">
  </div>

  <div id="map"></div>

  <table id="resultTable">
    <thead>
      <tr>
        <th>Svenskt namn</th>
        <th>Vetenskapligt namn</th>
        <th>Biodiversitet</th>
        <th>Nektar</th>
        <th>Antal</th>
        <th>Växtsätt</th>
        <th>Medelhöjd (m)</th>
        <th>Ljus</th>
        <th>Fukt</th>
        <th>Salt</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
  // ====== LÄGG DIN API-NYCKEL HÄR ======
  const SOS_API_KEY = "DIN_API_NYCKEL_HÄR";

  // ===== Hjälpare =====
  const $ = s => document.querySelector(s);
  const statusEl = $('#statusMsg');
  const setStatus = t => statusEl.textContent = t;
  const escapeHTML = s => String(s).replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const asNumber = x => { const n=parseFloat(String(x??'').replace(',','.')); return Number.isFinite(n)? n : null; };
  const toMetersFromCm = v => { const n=asNumber(v); return n==null? null : n/100; };
  function normalizeSciName(s) {
    if (!s) return '';
    return String(s)
      .replace(/\s+subsp\..*/i,'')
      .replace(/\s+var\..*/i,'')
      .replace(/\s+\(.+?\)/g,'')
      .replace(/\s+[A-ZÅÄÖ][a-z]+\.?$/,'')
      .trim()
      .split(/\s+/).slice(0,2).join(' ')
      .toLowerCase();
  }

  // Donut-progress
  function showProgress(){ $('#progressContainer').style.display='block'; updateProgress(0); }
  function hideProgress(){ $('#progressContainer').style.display='none'; }
  function updateProgress(frac){
    const canvas=$('#progressDonut'); const ctx=canvas.getContext('2d'); const size=canvas.width;
    ctx.clearRect(0,0,size,size);
    ctx.beginPath(); ctx.arc(size/2,size/2,size/2-6,0,2*Math.PI); ctx.strokeStyle='#223344'; ctx.lineWidth=12; ctx.stroke();
    ctx.beginPath(); ctx.arc(size/2,size/2,size/2-6,-Math.PI/2,-Math.PI/2+2*Math.PI*frac); ctx.strokeStyle='#77aaff'; ctx.lineWidth=12; ctx.stroke();
  }

  // CSV-parsning
  function parseCSV(text, delimiter=';'){ /* samma som tidigare */ }

  // ... (samma CSV-inläsning, karta, SOS-fetch, analyzeBtn, renderTable, plotAllPoints, selectSpecies, makeSortable som i din senaste version)
  // enda ändringen i fetchFromSOS: använd SOS_API_KEY direkt, inte från input.

  async function fetchFromSOS(lat, lng, radiusMeters){
    const url = 'https://api.artdatabanken.se/species-observation-system/v1/Exports/Download/GeoJson'
      + '?validateSearchFilter=false&propertyLabelType=Swedish&cultureCode=sv-SE'
      + '&flat=true&excludeNullValues=false&gzip=false&sensitiveObservations=false';
    const geom = circlePolygon(lng, lat, radiusMeters);
    const body = {
      determinationFilter: 'NoFilter',
      occurrenceStatus: 'Present',
      verificationStatus: 'BothVerifiedAndNotVerified',
      geographics: { geometries: [ geom ] },
      output: { fieldSet: 'All' },
      taxon: { attributes: {} }
    };
    const res = await fetch(url, {
      method:'POST',
      headers:{
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'X-Api-Version': '1.5',
        'Ocp-Apim-Subscription-Key': SOS_API_KEY
      },
      body: JSON.stringify(body)
    });
    if(!res.ok){ throw new Error('SOS HTTP '+res.status); }
    const gj = await res.json();
    return Array.isArray(gj?.features) ? gj.features : [];
  }

  // (resten som tidigare...)
  </script>
</body>
</html>
