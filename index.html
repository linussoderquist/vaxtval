<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hitta lämpliga inhemska växtarter (SOS Export)</title>
  <link rel="icon" href="icon.png" type="image/png" sizes="32x32">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    :root{--bg:#0b0f14;--text:#ecf1f6;--muted:#a5b6c9;--hl:#77aaff}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",Arial}
    header{padding:12px 16px;border-bottom:1px solid #1a2533;background:#0d1420}
    h1{margin:0 0 6px;font-size:26px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    input[type="number"],input[type="password"],input[type="text"]{
      background:#0a1320;border:1px solid #263447;color:var(--text);border-radius:8px;padding:8px 10px}
    input[type="number"]{width:120px}
    button{background:#0f2134;border:1px solid #2b4460;border-radius:12px;color:#eaf2fa;padding:9px 14px;cursor:pointer}
    button:hover{filter:brightness(1.06)}
    #statusMsg{color:var(--muted);font-size:13px;margin-left:6px}
    label.chk{display:inline-flex;align-items:center;gap:6px}
    #map{height:54vh}
    table{width:100%;border-collapse:separate;border-spacing:0 6px;margin:12px 0}
    thead th{font-size:13px;color:var(--muted);text-align:left;cursor:pointer;padding:6px 8px;background:#0e1724}
    tbody tr{background:#0f1723;border:1px solid #1e2b3b}
    tbody td{padding:8px 10px}
    tr:hover{outline:1px solid #27405f}
    tr.selected{outline:2px solid gold;background-color:#3b2b00} /* guldgul vald rad */
    .tag{font-size:11px;border:1px solid #2a4462;border-radius:999px;padding:2px 6px;color:#cfe1ff;background:#0e1b2f}
    .hint{font-size:13px;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
  <header>
    <h1>Hitta lämpliga inhemska växtarter</h1>
    <div class="controls">
      <span id="csvAutoBadge" class="hint" style="display:none;">vaxtdata.csv lästes automatiskt ✅</span>
      <label id="csvPicker">vaxtdata.csv
        <input type="file" id="csvInput" accept=".csv">
      </label>
      Radie (m): <input type="number" id="radiusInput" value="500" min="10" step="10">
      <label>API-nyckel:
        <input type="password" id="sosKey" placeholder="Ocp-Apim-Subscription-Key" size="28">
      </label>
      <label class="chk"><input type="checkbox" id="ignoreCsv"> Ignorera CSV (visa alla)</label>
      <button id="analyzeBtn">Analysera</button>
      <span id="statusMsg">1) CSV laddas…  2) Klicka i kartan  3) Analysera</span>
    </div>
    <div class="hint">För GitHub Pages: lägg <code>index.html</code>, <code>vaxtdata.csv</code> och <code>icon.png</code> i samma mapp.</div>
  </header>

  <!-- Donut-progress med icon.png i mitten -->
  <div id="progressContainer" style="display:none;position:fixed;z-index:9999;right:16px;bottom:16px;
    width:120px;height:120px;padding:6px;border-radius:14px;background:rgba(13,20,32,.85);box-shadow:0 8px 24px rgba(0,0,0,.35);">
    <canvas id="progressDonut" width="120" height="120"></canvas>
    <img src="icon.png" alt="ikon" style="position:absolute;top:50%;left:50%;width:48px;height:48px;transform:translate(-50%,-50%);pointer-events:none;">
  </div>

  <div id="map"></div>

  <table id="resultTable">
    <thead>
      <tr>
        <th>Svenskt namn</th>
        <th>Vetenskapligt namn</th>
        <th>Biodiversitet</th>
        <th>Nektar</th>
        <th>Antal</th>
        <th>Växtsätt</th>
        <th>Medelhöjd (m)</th>
        <th>Ljus</th>
        <th>Fukt</th>
        <th>Salt</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
  // ===== Hjälpare =====
  const $ = s => document.querySelector(s);
  const statusEl = $('#statusMsg');
  const setStatus = t => statusEl.textContent = t;
  const escapeHTML = s => String(s).replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const asNumber = x => { const n=parseFloat(String(x??'').replace(',','.')); return Number.isFinite(n)? n : null; };
  const toMetersFromCm = v => { const n=asNumber(v); return n==null? null : n/100; };

  // Normalisera vetenskapligt namn → "genus art"
  function normalizeSciName(s) {
    if (!s) return '';
    return String(s)
      .replace(/\s+subsp\..*/i,'')
      .replace(/\s+var\..*/i,'')
      .replace(/\s+\(.+?\)/g,'')
      .replace(/\s+[A-ZÅÄÖ][a-z]+\.?$/,'')
      .trim()
      .split(/\s+/).slice(0,2).join(' ')
      .toLowerCase();
  }

  // Donut-progress
  function showProgress(){ $('#progressContainer').style.display='block'; updateProgress(0); }
  function hideProgress(){ $('#progressContainer').style.display='none'; }
  function updateProgress(frac){
    const canvas=$('#progressDonut'); const ctx=canvas.getContext('2d'); const size=canvas.width;
    ctx.clearRect(0,0,size,size);
    ctx.beginPath(); ctx.arc(size/2,size/2,size/2-6,0,2*Math.PI); ctx.strokeStyle='#223344'; ctx.lineWidth=12; ctx.stroke();
    ctx.beginPath(); ctx.arc(size/2,size/2,size/2-6,-Math.PI/2,-Math.PI/2+2*Math.PI*frac); ctx.strokeStyle='#77aaff'; ctx.lineWidth=12; ctx.stroke();
  }

  // Semikolon-CSV med citattecken
  function parseCSV(text, delimiter=';'){
    const rows=[]; let i=0, field='', row=[], inQ=false;
    const pushF=()=>{row.push(field); field='';}; const pushR=()=>{rows.push(row); row=[];};
    while(i<text.length){
      const c=text[i];
      if(inQ){ if(c==='"'){ if(text[i+1]==='"'){ field+='"'; i++; } else inQ=false; } else field+=c; }
      else { if(c==='"') inQ=true; else if(c===delimiter) pushF(); else if(c==='\n'){ pushF(); pushR(); } else if(c!=='\r') field+=c; }
      i++;
    }
    if(field.length>0 || row.length>0){ pushF(); pushR(); }
    return rows.filter(r=> r.some(v=> String(v).trim().length>0));
  }

  // ===== Datahållare =====
  const speciesCsvById = new Map(); // dyntaxa -> csv
  const speciesByNorm  = new Map(); // normalizeSciName -> csv
  let csvLoaded = false;

  // ===== Karta =====
  const map = L.map('map').setView([62,15],5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
  let selectedPoint=null, clickMarker=null, bufferCircle=null;
  const layerAll = L.layerGroup().addTo(map);
  const layerSelected = L.layerGroup().addTo(map);

  map.on('click', e=>{
    selectedPoint = e.latlng;
    drawSelection();
    setStatus(`Punkt vald: ${selectedPoint.lat.toFixed(5)}, ${selectedPoint.lng.toFixed(5)} — klicka Analysera`);
  });

  function drawSelection(){
    const r = +$('#radiusInput').value||0;
    if(clickMarker) clickMarker.remove();
    if(bufferCircle) bufferCircle.remove();
    if(!selectedPoint || !r) return;
    clickMarker = L.marker(selectedPoint).addTo(map);
    bufferCircle = L.circle(selectedPoint, {radius:r, color:'#77f', fillOpacity:0.05}).addTo(map);
  }

  // ===== Ladda CSV: auto via fetch på http(s), annars via filväljare =====
  async function loadCsvTextFromSameFolder(){
    const url = 'vaxtdata.csv'; // samma mapp
    const res = await fetch(url, { cache:'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    return res.text();
  }

  async function parseAndIndexCsvText(txt){
    const rows = parseCSV(txt,';');
    const head = rows[0].map(h=>String(h).trim().toLowerCase());
    const idx = {
      dyntaxa: head.indexOf('dyntaxa id number'),
      sv: head.indexOf('svenskt namn'),
      sci: head.indexOf('scientific name'),
      bio: head.findIndex(h=>h.includes('biodivers')),
      nec: head.findIndex(h=>h.includes('nektar')),
      growth: head.findIndex(h=>h.includes('växtsätt')||h.includes('vaxtsätt')||h.includes('vaxtsatt')||h.includes('växtsatt')),
      height: head.findIndex(h=>h.includes('medelhöjd')),
      light: head.findIndex(h=>h==='light'||h.includes('ljus')),
      moist: head.findIndex(h=>h==='moisture'||h.includes('fukt')),
      salt: head.findIndex(h=>h==='salinity'||h.includes('salttålighet')||h.includes('salt'))
    };
    if(idx.sci===-1 || idx.sv===-1) throw new Error('Saknar Scientific name / Svenskt namn');
    speciesCsvById.clear(); speciesByNorm.clear();

    for(let r=1;r<rows.length;r++){
      const row=rows[r];
      const dx  = String(row[idx.dyntaxa]||'').trim();
      const sci = String(row[idx.sci]    ||'').trim();
      if(!sci) continue;
      const rec = {
        dyntaxa: dx,
        svName: row[idx.sv] || '',
        sciName: sci,
        biodiv: idx.bio>=0? asNumber(row[idx.bio]) : null,
        nectar: idx.nec>=0? asNumber(row[idx.nec]) : null,
        growth: idx.growth>=0? row[idx.growth] : '',
        height: idx.height>=0? toMetersFromCm(row[idx.height]) : null,
        light:  idx.light>=0? row[idx.light]  : '',
        moist:  idx.moist>=0? row[idx.moist]  : '',
        salt:   idx.salt>=0?  row[idx.salt]   : ''
      };
      if(dx) speciesCsvById.set(dx, rec);
      speciesByNorm.set(normalizeSciName(sci), rec);
    }
    csvLoaded = true;
  }

  async function tryAutoLoadCsv(){
    if(location.protocol.startsWith('http')){ // GitHub Pages, localhost etc.
      try{
        setStatus('Försöker läsa vaxtdata.csv…');
        const txt = await loadCsvTextFromSameFolder();
        await parseAndIndexCsvText(txt);
        setStatus(`CSV laddad (${speciesByNorm.size} arter) från samma mapp.`);
        $('#csvAutoBadge').style.display='inline';
        $('#csvPicker').style.display='none';
      }catch(err){
        console.warn('Auto-laddning av CSV misslyckades:', err);
        setStatus('CSV kunde inte laddas automatiskt – välj fil manuellt.');
        $('#csvPicker').style.display='inline';
      }
    }else{
      // file:// → måste använda filväljare
      $('#csvPicker').style.display='inline';
      setStatus('Välj CSV-fil (p.g.a. fil:// CORS).');
    }
  }

  // Filväljare fallback
  $('#csvInput').addEventListener('change', async (e)=>{
    const f = e.target.files?.[0]; if(!f){ setStatus('Ingen CSV vald'); return; }
    const txt = await f.text();
    try{
      await parseAndIndexCsvText(txt);
      setStatus(`CSV laddad (${speciesByNorm.size} arter). Välj plats i kartan.`);
    }catch(err){
      console.error(err);
      setStatus('Kunde inte tolka CSV: '+err.message);
    }
  });

  // ===== SOS Export (GeoJSON via POST) =====
  function circlePolygon(lon, lat, radiusMeters, steps=96){
    const R=6371000, coords=[];
    for(let i=0;i<=steps;i++){
      const a=2*Math.PI*(i/steps);
      const dx=(radiusMeters/R)*Math.cos(a);
      const dy=(radiusMeters/R)*Math.sin(a);
      const lat2 = lat + (dy*180/Math.PI);
      const lon2 = lon + (dx*180/Math.PI)/Math.cos(lat*Math.PI/180);
      coords.push([lon2, lat2]);
    }
    return { type:'Polygon', coordinates:[coords] };
  }

  async function fetchFromSOS(lat, lng, radiusMeters, apiKey){
    if (!Number.isFinite(lat) || !Number.isFinite(lng) || !Number.isFinite(radiusMeters) || radiusMeters <= 0) {
      throw new Error('Ogiltig punkt eller radie.');
    }
    const url = 'https://api.artdatabanken.se/species-observation-system/v1/Exports/Download/GeoJson'
      + '?validateSearchFilter=false&propertyLabelType=Swedish&cultureCode=sv-SE'
      + '&flat=true&excludeNullValues=false&gzip=false&sensitiveObservations=false';
    const geom = circlePolygon(lng, lat, radiusMeters);
    const body = {
      determinationFilter: 'NoFilter',
      occurrenceStatus: 'Present',
      verificationStatus: 'BothVerifiedAndNotVerified',
      geographics: { geometries: [ geom ] },
      output: { fieldSet: 'All' },
      taxon: { attributes: {} }
    };

    const res = await fetch(url, {
      method:'POST',
      headers:{
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'X-Api-Version': '1.5',
        'Ocp-Apim-Subscription-Key': apiKey
      },
      body: JSON.stringify(body)
    });

    if(!res.ok){
      let msg=`SOS HTTP ${res.status}`;
      try{
        const txt=await res.text();
        if(txt){ try{ const j=JSON.parse(txt); msg+=' – '+(j.title||j.detail||j.message||txt); } catch{ msg+=' – '+txt; } }
      }catch{}
      throw new Error(msg);
    }
    const gj = await res.json();
    return Array.isArray(gj?.features) ? gj.features : [];
  }

  // ===== Analysera =====
  $('#analyzeBtn').addEventListener('click', async ()=>{
    if(!selectedPoint){ alert('Klicka i kartan för att välja plats.'); return; }
    const r = +$('#radiusInput').value || 0;
    if(r<=0){ alert('Ange radie > 0.'); return; }
    const key = $('#sosKey').value.trim();
    if(!key){ alert('Ange din Ocp-Apim-Subscription-Key.'); return; }
    const ignoreCsv = $('#ignoreCsv').checked;

    try{
      showProgress(); updateProgress(0.1);
      setStatus('Hämtar från ArtDatabanken…'); updateProgress(0.3);

      const feats = await fetchFromSOS(selectedPoint.lat, selectedPoint.lng, r, key);
      updateProgress(0.6);
      const rawCount = feats.length;

      const per = new Map(); // k -> {count,csv,feats}
      for(const f of feats){
        const p = f.properties || {};
        const dx = String(p["Dyntaxa taxon id"] ?? p["Taxon ID"] ?? p.dyntaxaTaxonId ?? p.taxonId ?? '').trim();
        const sciRaw = String(p["Vetenskapligt namn"] ?? p.scientificName ?? '').trim();
        const svFromSOS = String(p["Svenskt namn"] ?? '').trim();
        const norm = normalizeSciName(sciRaw);
        const k = dx || norm || sciRaw; if(!k) continue;

        let csv = null;
        if(ignoreCsv){
          csv = (dx && speciesCsvById.get(dx)) || speciesByNorm.get(norm) || {
            dyntaxa: dx, svName: svFromSOS, sciName: sciRaw,
            biodiv:null, nectar:null, growth:'', height:null, light:'', moist:'', salt:''
          };
        }else{
          if(!csvLoaded){ alert('CSV inte laddad. Låt auto-laddning lyckas eller välj fil.'); hideProgress(); return; }
          if(dx && speciesCsvById.has(dx)) csv = speciesCsvById.get(dx);
          else csv = speciesByNorm.get(norm);
          if(!csv) continue;
        }

        if(!per.has(k)) per.set(k, {count:0, csv, feats:[]});
        const rec = per.get(k); rec.count++; rec.feats.push(f);
      }

      const afterCount = [...per.values()].reduce((s,r)=>s+r.count,0);
      const rows = [...per.values()].map(r=> ({...r, score:(r.csv.biodiv??0)*2 + (r.csv.nectar??0)}))
        .sort((a,b)=>{ const s=(b.score??0)-(a.score??0); if(s) return s; return (b.count??0)-(a.count??0); });

      renderTable(rows);
      plotAllPoints(rows);
      setStatus(`Råa obs: ${rawCount} • Efter filter: ${afterCount} • Arter i tabell: ${rows.length} (radie ${r} m)`);
      updateProgress(1.0); setTimeout(hideProgress, 500);
    }catch(err){
      console.error(err);
      setStatus('Fel: '+err.message);
      alert('Fel vid SOS-hämtning: '+err.message);
      hideProgress();
    }
  });

  // ===== Tabell & karta =====
  function renderTable(items){
    const tb = $('#resultTable tbody'); tb.innerHTML='';
    for(const rec of items){
      const c=rec.csv;
      const tr=document.createElement('tr'); tr.tabIndex=0; tr.dataset.sci=c.sciName;
      tr.innerHTML =
        `<td>${escapeHTML(c.svName||'')}</td>`+
        `<td><i>${escapeHTML(c.sciName||'')}</i></td>`+
        `<td>${c.biodiv??'–'}</td>`+
        `<td>${c.nectar??'–'}</td>`+
        `<td>${rec.count}</td>`+
        `<td><span class="tag">${escapeHTML(c.growth||'')}</span></td>`+
        `<td>${c.height==null? '–' : c.height.toFixed(2)}</td>`+
        `<td>${escapeHTML(c.light||'')}</td>`+
        `<td>${escapeHTML(c.moist||'')}</td>`+
        `<td>${escapeHTML(c.salt||'')}</td>`;
      tr.addEventListener('click',()=> selectSpecies(c.sciName));
      tr.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); selectSpecies(c.sciName);} });
      tb.appendChild(tr);
    }
    makeSortable();
    window._lastRows = items;
  }

  function plotAllPoints(items){
    layerAll.clearLayers(); layerSelected.clearLayers();
    const markers=[];
    for(const rec of items){
      for(const f of rec.feats){
        const g=f.geometry; if(!g||g.type!=='Point') continue;
        const [lon,lat] = g.coordinates;
        const m=L.circleMarker([lat,lon],{radius:3,color:'#6ea8ff',fillOpacity:.6}); 
        m.addTo(layerAll); markers.push(m);
      }
    }
    if(markers.length){ map.fitBounds(L.featureGroup(markers).getBounds().pad(0.2)); }
  }

  function selectSpecies(sci){
    document.querySelectorAll('#resultTable tbody tr').forEach(tr=> tr.classList.toggle('selected', tr.dataset.sci===sci));
    const rec = (window._lastRows||[]).find(r=> (r.csv.sciName||'')===sci);
    if(!rec) return;
    layerSelected.clearLayers();
    const pts=[];
    for(const f of rec.feats){
      const g=f.geometry; if(!g||g.type!=='Point') continue;
      const [lon,lat] = g.coordinates;
      const m=L.circleMarker([lat,lon],{
        radius:6, color:'#FFD700', weight:2, fillColor:'#FFD700', fillOpacity:.6  // guldgula markerade punkter
      });
      m.addTo(layerSelected); pts.push(m);
    }
    if(pts.length){ map.fitBounds(L.featureGroup(pts).getBounds().pad(0.2)); }
  }

  function makeSortable(){
    const thead=$('#resultTable thead'); const tbody=$('#resultTable tbody'); const heads=[...thead.querySelectorAll('th')];
    heads.forEach((th,idx)=> th.addEventListener('click',()=>{
      const asc = !(th.classList.contains('sorted') && th.classList.contains('asc'));
      heads.forEach(h=> h.classList.remove('sorted','asc','desc')); th.classList.add('sorted', asc?'asc':'desc');
      const rows=[...tbody.rows];
      rows.sort((a,b)=>{ const av=a.cells[idx].innerText.trim(); const bv=b.cells[idx].innerText.trim();
        const an=parseFloat(av.replace(',','.')); const bn=parseFloat(bv.replace(',','.'));
        const bothNum=!isNaN(an)&&!isNaN(bn); let s=0; if(bothNum){ s=an-bn; } else { s=av.localeCompare(bv,'sv'); }
        return asc? s : -s;
      });
      rows.forEach(r=> tbody.appendChild(r));
    }));
  }

  // Start: försök auto-ladda CSV vid http(s)
  tryAutoLoadCsv();
  </script>
</body>
</html>
